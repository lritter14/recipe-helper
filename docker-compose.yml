services:
  ollama:
    image: ollama/ollama:latest
    container_name: recipe-ingest-ollama
    restart: unless-stopped
    ports:
      - "${OLLAMA_PORT:-11435}:11434"
    networks:
      - recipe-network
    volumes:
      - ollama-data:/root/.ollama
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    environment:
      - OLLAMA_HOST=0.0.0.0:11434

  recipe-api:
    # Use locally built image by default (set via DOCKER_IMAGE env var to override)
    # Build locally with: docker build -t recipe-ingest:local .
    image: ${DOCKER_IMAGE:-recipe-ingest:local}
    container_name: recipe-ingest-api
    restart: unless-stopped
    ports:
      - "${API_PORT:-8100}:${API_PORT:-8100}"
    networks:
      - recipe-network
    environment:
      - RECIPE_INGEST_LLM_ENDPOINT=${RECIPE_INGEST_LLM_ENDPOINT:-http://ollama:11434}
      - RECIPE_INGEST_LLM_MODEL=${RECIPE_INGEST_LLM_MODEL:-llama3.1:8b}
      - RECIPE_INGEST_VAULT_PATH=${RECIPE_INGEST_VAULT_PATH:-/vault}
      - RECIPE_INGEST_LOG_LEVEL=${RECIPE_INGEST_LOG_LEVEL:-INFO}
      - API_PORT=${API_PORT:-8100}
    volumes:
      - ${VAULT_PATH:-/Users/loganritter/Documents/Obsidian/Personal}:/vault
    depends_on:
      ollama:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:$$API_PORT/api/v1/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    labels:
      # Watchtower label to enable automatic updates
      - "com.centurylinklabs.watchtower.enable=true"

  tailscale:
    image: tailscale/tailscale:latest
    container_name: recipe-ingest-tailscale
    restart: unless-stopped
    # Share the *recipe-api* network namespace instead of the other way around
    network_mode: "service:recipe-api"
    environment:
      - TS_AUTH_KEY=${TS_AUTH_KEY}
    volumes:
      - tailscale-state:/var/lib/tailscale
      - ./scripts/start-tailscale.sh:/start-tailscale.sh:ro
    command: ["/bin/sh", "/start-tailscale.sh", "recipe-ingest", "${API_PORT:-8100}"]
    depends_on:
      recipe-api:
        condition: service_healthy


networks:
  recipe-network:
    driver: bridge

volumes:
  tailscale-state:
    driver: local
  ollama-data:
    driver: local
